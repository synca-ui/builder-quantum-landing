generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USERs & AUTH (Clerk Integration)
// ============================================

model User {
  id            String    @id @default(uuid())
  clerkId       String    @unique @map("clerk_id")
  email         String    @unique
  fullName      String?
  role          UserRole  @default(OWNER)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  businesses    BusinessMember[]
  webApps       WebApp[]
  configurations Configuration[]
  tenants       Tenant[]
  scraperJobs   ScraperJob[]
  subscription  Subscription?
  billingEvents BillingEvent[]
  auditLogs     AuditLog[]
  templateRatings TemplateRating[]
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
}

// ============================================
// 2. BUSINESS MANAGEMENT
// ============================================

model Business {
  id              String   @id @default(uuid())
  slug            String   @unique

  // Core Info
  name            String
  description     String?  @db.Text
  tagline         String?
  cuisine         String?

  // Branding
  logoUrl         String?
  primaryColor    String   @default("#000000")
  secondaryColor  String   @default("#ffffff")
  fontFamily      String   @default("sans")

  // Template Reference (✅ NEW: Proper foreign key)
  templateId      String?
  template        Template? @relation(fields: [templateId], references: [id])

  // Operational Data
  openingHours    Json?
  socialLinks     Json?
  contactInfo     Json?

  // Status
  maitrScore      Int      @default(0)
  originalPdfUrl  String?
  status          BusinessStatus @default(DRAFT)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  members         BusinessMember[]
  categories      MenuCategory[]
  configurations  Configuration[]

  @@index([slug])
  @@index([status])
}

enum BusinessStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model BusinessMember {
  id          String   @id @default(uuid())
  userId      String
  businessId  String
  role        UserRole @default(STAFF)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([businessId])
}

// ============================================
// 3. TEMPLATE MARKETPLACE (✅ NEW)
// ============================================

model Template {
  id              String    @id  // e.g., "minimalist", "modern", "stylish", "cozy"

  // Metadata
  name            String
  description     String    @db.Text
  version         String    @default("1.0.0")
  isPremium       Boolean   @default(false)

  // Categorization
  category        String    // "restaurant", "cafe", "bar", "retail", "service"

  // Design System
  layout          Json      @default("{}")    // { intent, navigation, typography }
  tokens          Json      @default("{}")    // { colors, typography, spacing, shapes }
  preview         Json      @default("{}")    // { thumbnail, features }

  // Marketplace Metrics
  creator         String    @default("maitr")
  downloads       Int       @default(0)
  avgRating       Float     @default(0)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  businesses      Business[]
  configurations  Configuration[]
  ratings         TemplateRating[]

  @@index([isPremium])
  @@index([category])
  @@index([downloads])
}

model TemplateRating {
  id              String    @id @default(uuid())
  templateId      String
  userId          String
  rating          Int       // 1-5 stars
  comment         String?   @db.Text

  createdAt       DateTime  @default(now())

  template        Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
}

// ============================================
// 4. CONFIGURATIONS (✅ WITH RLS SUPPORT)
// ============================================

model Configuration {
  id              String    @id @default(uuid())
  userId          String    // ✅ RLS: User ownership
  businessId      String?   // ✅ RLS: Business ownership

  // Business Info
  businessName    String    @default("")
  businessType    String    @default("")
  location        String?
  slogan          String?
  uniqueDescription String?

  // Design
  template        String    @default("")  // Legacy field
  selectedTemplate String?  // ✅ NEW: FK to Template
  primaryColor    String    @default("#111827")
  secondaryColor  String    @default("#6B7280")
  fontFamily      String    @default("sans-serif")
  backgroundColor String    @default("#FFFFFF")

  // Content
  menuItems       Json      @default("[]")
  gallery         Json      @default("[]")
  openingHours    Json      @default("{}")

  // Features
  reservationsEnabled Boolean @default(false)
  maxGuests       Int       @default(10)
  onlineOrdering  Boolean   @default(false)
  onlineStore     Boolean   @default(false)
  teamArea        Boolean   @default(false)

  // Contact & Social
  contactMethods  Json      @default("[]")
  socialMedia     Json      @default("{}")

  // Pages
  selectedPages   Json      @default("[\"home\"]")
  customPages     Json      @default("[]")

  // Publishing
  status          String    @default("draft")  // draft | published | archived
  publishedUrl    String?   @unique
  previewUrl      String?

  // Extra
  domainName      String?
  selectedDomain  String?
  paymentOptions  Json      @default("[]")
  offers          Json      @default("[]")

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business        Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  templateData    Template? @relation(fields: [selectedTemplate], references: [id], onDelete: SetNull)
  addOns          AddOnInstance[]

  // ✅ RLS Indexes
  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@index([status])
}

// ============================================
// 5. MENU MANAGEMENT
// ============================================

model MenuCategory {
  id          String     @id @default(uuid())
  name        String
  sortOrder   Int        @default(0)
  businessId  String
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items       MenuItem[]

  @@index([businessId])
}

model MenuItem {
  id          String       @id @default(uuid())
  name        String
  description String?      @db.Text
  price       Decimal      @db.Decimal(10, 2)
  imageUrl    String?

  categoryId  String
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  category    MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

// ============================================
// 6. WEB APPS (Published Websites)
// ============================================

model WebApp {
  id            String    @id @default(uuid())
  userId        String
  configId      String    @unique  // ✅ NEW: Link to Configuration
  subdomain     String    @unique
  configData    Json
  publishedAt   DateTime?
  updatedAt     DateTime  @updatedAt

  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        OrderEvent[]

  @@index([userId])
  @@index([subdomain])
}

// ============================================
// 7. ORDER EVENTS (Social Proof & Analytics)
// ============================================

model OrderEvent {
  id              String    @id @default(uuid())
  webAppId        String
  orderId         String?
  menuItemId      String?
  menuItemName    String
  orderedAt       DateTime  @default(now())
  orderSource     String    // 'stripe' | 'pos_api' | 'manual'
  userAvatarUrl   String?

  webApp          WebApp    @relation(fields: [webAppId], references: [id], onDelete: Cascade)

  @@index([webAppId])
  @@index([orderedAt])
}

// ============================================
// 8. SUBSCRIPTION & BILLING (✅ NEW - Stripe Integration)
// ============================================

model Subscription {
  id              String    @id @default(uuid())
  userId          String    @unique
  
  // Stripe References
  stripeCustomerId String? @unique
  stripeSubscriptionId String? @unique
  
  // Plan Info
  plan            String    @default("free")  // free | basic | pro | enterprise
  status          String    @default("active")  // active | paused | canceled | past_due
  
  // Features
  maxSites        Int       @default(1)
  maxUsers        Int       @default(1)
  
  // Billing Period
  currentPeriodStart DateTime?
  currentPeriodEnd DateTime?
  canceledAt      DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([stripeCustomerId])
}

model BillingEvent {
  id              String    @id @default(uuid())
  userId          String
  subscriptionId  String?
  
  eventType       String    // subscription_created | payment_succeeded | invoice_paid | payment_failed
  amount          Int?      // Cents
  currency        String    @default("EUR")
  
  stripeEventId   String?   @unique
  metadata        Json?
  
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([eventType])
}

// ============================================
// 9. n8n SCRAPER PIPELINE (✅ NEW)
// ============================================

model ScraperJob {
  id              String    @id @default(uuid())
  
  // Input
  businessName    String
  businessType    String    @default("restaurant")
  websiteUrl      String    @unique
  
  // Execution
  n8nExecutionId  String?
  status          String    @default("pending")  // pending | processing | completed | failed
  
  // Results
  extractedData   Json?     // Raw data from n8n
  suggestedConfig Json?     // Pre-populated Configuration
  
  // Linking
  userId          String?
  linkedConfigId  String?   @unique
  
  // Error Handling
  failureReason   String?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// 10. PLUGIN/ADD-ON SYSTEM (✅ NEW)
// ============================================

model AddOnRegistry {
  id              String    @id  // e.g., "calendly-reservations"
  name            String
  description     String    @db.Text
  category        String    // "reservations" | "pos" | "staff" | "marketing"
  
  // Plugin Manifest
  manifest        Json      // { entrypoint, slots: [], config: {} }
  version         String    @default("1.0.0")
  creator         String    @default("maitr")
  
  // Marketplace
  isPublished     Boolean   @default(false)
  isPremium       Boolean   @default(false)
  
  // Metrics
  installations   Int       @default(0)
  avgRating       Float     @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  instances       AddOnInstance[]
  
  @@index([category])
  @@index([isPublished])
}

model AddOnInstance {
  id              String    @id @default(uuid())
  configId        String
  addOnId         String
  
  // Configuration
  config          Json      @default("{}")  // Add-on specific config
  status          String    @default("active")  // active | inactive | error
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  configuration   Configuration @relation(fields: [configId], references: [id], onDelete: Cascade)
  addOn           AddOnRegistry @relation(fields: [addOnId], references: [id], onDelete: Cascade)
  
  @@unique([configId, addOnId])
  @@index([configId])
}

// ============================================
// 11. AUDIT LOG (✅ NEW - Compliance & Security)
// ============================================

model AuditLog {
  id              String    @id @default(uuid())
  userId          String
  action          String    // config_created | config_modified | config_deleted | config_published
  resource        String    // "configuration" | "subscription" | "addon"
  resourceId      String
  
  // Request Context
  ipAddress       String?
  userAgent       String?
  
  // Result
  success         Boolean   @default(true)
  errorMessage    String?
  
  // Changes
  changes         Json?     // { before: {}, after: {} }
  
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resource, resourceId])
}

// ============================================
// 12. MULTI-TENANT SUPPORT (Legacy)
// ============================================

model Tenant {
  id              String    @id @default(uuid())
  slug            String    @unique
  userId          String
  schemaName      String    @unique
  restaurantId    String

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurants     Restaurant[]
}

model Restaurant {
  id              String    @id @default(uuid())
  tenantId        String
  name            String
  configJson      Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}
