generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. USER & AUTH ---
model User {
  id            String    @id @default(uuid())
  clerkId       String    @unique @map("clerk_id")  // Clerk user ID for authentication
  email         String    @unique
  fullName      String?
  role          UserRole  @default(OWNER)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  businesses    BusinessMember[]
  webApps       WebApp[]
  tenants       Tenant[]
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
}

// --- 2. BUSINESS (Hybrid Model) ---
model Business {
  id              String   @id @default(uuid())
  slug            String   @unique
  
  // Core Info
  name            String
  description     String?  @db.Text
  tagline         String?
  cuisine         String?
  
  // Branding
  logoUrl         String?
  primaryColor    String   @default("#000000")
  secondaryColor  String   @default("#ffffff")
  fontFamily      String   @default("sans")
  template        String   @default("minimalist")
  
  // Operational Data (JSON for flexibility)
  openingHours    Json?    
  socialLinks     Json?    
  contactInfo     Json?    
  
  // Scraper Meta
  maitrScore      Int      @default(0)
  originalPdfUrl  String?
  status          BusinessStatus @default(DRAFT)

  // Relations
  members         BusinessMember[]
  categories      MenuCategory[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum BusinessStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model BusinessMember {
  id          String   @id @default(uuid())
  userId      String
  businessId  String
  role        UserRole @default(STAFF)
  
  user        User     @relation(fields: [userId], references: [id])
  business    Business @relation(fields: [businessId], references: [id])

  @@unique([userId, businessId])
}

// --- 3. MENU ---
model MenuCategory {
  id          String     @id @default(uuid())
  name        String
  sortOrder   Int        @default(0)
  businessId  String
  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items       MenuItem[]
}

model MenuItem {
  id          String       @id @default(uuid())
  name        String
  description String?      @db.Text
  price       Decimal      @db.Decimal(10, 2)
  imageUrl    String?

  categoryId  String
  category    MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

// --- 4. CONFIGURATIONS (User Site Drafts & Published Configs) ---
model Configuration {
  id            String    @id @default(uuid())
  userId        String

  // Business Info
  businessName  String    @default("")
  businessType  String    @default("")
  location      String?
  slogan        String?
  uniqueDescription String?

  // Design
  template      String    @default("")
  primaryColor  String    @default("#111827")
  secondaryColor String   @default("#6B7280")
  fontFamily    String    @default("sans-serif")

  // Content
  menuItems     Json      @default("[]") // Array<MenuItem>
  gallery       Json      @default("[]") // Array<GalleryImage>
  openingHours  Json      @default("{}") // OpeningHours object

  // Features
  reservationsEnabled Boolean @default(false)
  maxGuests     Int       @default(10)
  onlineOrdering Boolean  @default(false)
  onlineStore   Boolean   @default(false)
  teamArea      Boolean   @default(false)

  // Contact & Social
  contactMethods Json     @default("[]") // Array<string>
  socialMedia   Json      @default("{}") // Record<string, string>

  // Pages
  selectedPages Json      @default("[\"home\"]") // Array<string>
  customPages   Json      @default("[]") // Array<string>

  // Publishing
  status        String    @default("draft") // "draft" | "published" | "archived"
  publishedUrl  String?
  previewUrl    String?

  // Extra
  domainName    String?
  selectedDomain String?
  paymentOptions Json     @default("[]")
  offers        Json      @default("[]")

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// --- 5. WEB APPS (Published Websites) ---
model WebApp {
  id            String    @id @default(uuid())
  userId        String
  subdomain     String    @unique
  configData    Json
  publishedAt   DateTime?
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        OrderEvent[]

  createdAt     DateTime  @default(now())
}

// --- 5. ORDER EVENTS (Social Proof) ---
model OrderEvent {
  id              String    @id @default(uuid())
  webAppId        String
  orderId         String?
  menuItemId      String?
  menuItemName    String
  orderedAt       DateTime  @default(now())
  orderSource     String    // 'stripe' | 'pos_api' | 'manual'
  userAvatarUrl   String?

  webApp          WebApp    @relation(fields: [webAppId], references: [id], onDelete: Cascade)

  @@index([webAppId])
  @@index([orderedAt])
}

// --- 6. TENANTS (Multi-tenant Support) ---
model Tenant {
  id              String    @id @default(uuid())
  slug            String    @unique
  userId          String
  schemaName      String    @unique
  restaurantId    String

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurants     Restaurant[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// --- 7. RESTAURANT (Tenant-local config) ---
model Restaurant {
  id              String    @id @default(uuid())
  tenantId        String
  name            String
  configJson      Json?

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
