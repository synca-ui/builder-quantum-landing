generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(uuid())
  clerkId         String           @unique @map("clerk_id")
  email           String           @unique
  fullName        String?
  role            UserRole         @default(OWNER)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  auditLogs       AuditLog[]
  billingEvents   BillingEvent[]
  businesses      BusinessMember[]
  configurations  Configuration[]
  scraperJobs     ScraperJob[]
  subscription    Subscription?
  templateRatings TemplateRating[]
  tenants         Tenant[]
  webApps         WebApp[]
}

model Business {
  id                 String              @id @default(uuid())
  slug               String              @unique
  name               String
  description        String?
  tagline            String?
  cuisine            String?
  logoUrl            String?
  primaryColor       String              @default("#000000")
  secondaryColor     String              @default("#ffffff")
  fontFamily         String              @default("sans")
  templateId         String?
  openingHours       Json?
  socialLinks        Json?
  contactInfo        Json?
  maitrScore         Int                 @default(0)
  originalPdfUrl     String?
  status             BusinessStatus      @default(DRAFT)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  analyticsSnapshots AnalyticsSnapshot[]
  template           Template?           @relation(fields: [templateId], references: [id])
  members            BusinessMember[]
  configurations     Configuration[]
  floorPlans         FloorPlan[]
  categories         MenuCategory[]
  orders             Order[]
  reservations       Reservation[]
  tables             Table[]

  @@index([slug])
  @@index([status])
}

model BusinessMember {
  id         String   @id @default(uuid())
  userId     String
  businessId String
  role       UserRole @default(STAFF)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([businessId])
}

model AnalyticsSnapshot {
  id               String   @id @default(uuid())
  businessId       String
  revenue          Decimal  @default(0) @db.Decimal(10, 2)
  orders           Int      @default(0)
  uniqueVisitors   Int      @default(0)
  qrScans          Int      @default(0)
  trafficDirect    Int      @default(0)
  trafficGoogle    Int      @default(0)
  trafficFacebook  Int      @default(0)
  trafficInstagram Int      @default(0)
  trafficQR        Int      @default(0)
  trafficOther     Int      @default(0)
  avgOrderValue    Decimal  @default(0) @db.Decimal(10, 2)
  popularItems     Json     @default("[]")
  date             DateTime @default(now()) @db.Date
  period           String   @default("daily")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  business         Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, date, period])
  @@index([businessId, date])
  @@index([date, period])
}

model Reservation {
  id              String            @id @default(uuid())
  businessId      String
  tableId         String?
  guestName       String
  guestEmail      String?
  guestPhone      String?
  guestCount      Int               @default(2)
  reservationTime DateTime
  duration        Int               @default(120)
  specialRequests String?
  status          ReservationStatus @default(PENDING)
  source          String            @default("website")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  business        Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  table           Table?            @relation(fields: [tableId], references: [id])

  @@index([businessId, reservationTime])
  @@index([reservationTime, status])
}

model FloorPlan {
  id          String   @id @default(uuid())
  businessId  String
  name        String
  description String?
  width       Int      @default(800)
  height      Int      @default(600)
  gridSize    Int      @default(20)
  bgColor     String   @default("#f8fafc")
  bgImage     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tables      Table[]

  @@index([businessId])
  @@index([businessId, isActive])
}

model Table {
  id           String        @id @default(uuid())
  floorPlanId  String
  businessId   String
  number       String
  name         String?
  x            Float
  y            Float
  rotation     Float         @default(0)
  shape        TableShape    @default(ROUND)
  width        Float         @default(80)
  height       Float         @default(80)
  minCapacity  Int           @default(2)
  maxCapacity  Int           @default(4)
  qrEnabled    Boolean       @default(false)
  qrCode       String?
  qrCodeImage  String?
  status       TableStatus   @default(AVAILABLE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  orders       Order[]
  reservations Reservation[]
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  floorPlan    FloorPlan     @relation(fields: [floorPlanId], references: [id], onDelete: Cascade)

  @@unique([businessId, number])
  @@index([floorPlanId])
  @@index([businessId])
  @@index([businessId, status])
}

model Order {
  id              String      @id @default(uuid())
  businessId      String
  tableId         String?
  orderNumber     String      @unique
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  subtotal        Decimal     @db.Decimal(10, 2)
  tax             Decimal     @default(0) @db.Decimal(10, 2)
  tip             Decimal     @default(0) @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  items           Json
  status          OrderStatus @default(PENDING)
  orderType       OrderType   @default(DINE_IN)
  source          String      @default("qr-code")
  notes           String?
  specialRequests String?
  orderedAt       DateTime    @default(now())
  confirmedAt     DateTime?
  preparedAt      DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  business        Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  table           Table?      @relation(fields: [tableId], references: [id])

  @@index([businessId, orderedAt])
  @@index([orderNumber])
  @@index([status])
}

model Template {
  id             String           @id
  name           String
  description    String
  version        String           @default("1.0.0")
  isPremium      Boolean          @default(false)
  category       String
  layout         Json             @default("{}")
  tokens         Json             @default("{}")
  preview        Json             @default("{}")
  creator        String           @default("maitr")
  downloads      Int              @default(0)
  avgRating      Float            @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  businesses     Business[]
  configurations Configuration[]
  ratings        TemplateRating[]

  @@index([isPremium])
  @@index([category])
  @@index([downloads])
}

model TemplateRating {
  id         String   @id @default(uuid())
  templateId String
  userId     String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
}

model Configuration {
  id                          String          @id @default(uuid())
  userId                      String
  businessId                  String?
  businessName                String          @default("")
  businessType                String          @default("")
  location                    String?
  slogan                      String?
  uniqueDescription           String?
  template                    String          @default("")
  selectedTemplate            String?
  primaryColor                String          @default("#111827")
  secondaryColor              String          @default("#6B7280")
  fontFamily                  String          @default("sans-serif")
  menuItems                   Json            @default("[]")
  gallery                     Json            @default("[]")
  openingHours                Json            @default("{}")
  reservationsEnabled         Boolean         @default(false)
  maxGuests                   Int             @default(10)
  onlineOrdering              Boolean         @default(false)
  onlineStore                 Boolean         @default(false)
  teamArea                    Boolean         @default(false)
  contactMethods              Json            @default("[]")
  socialMedia                 Json            @default("{}")
  selectedPages               Json            @default("[\"home\"]")
  customPages                 Json            @default("[]")
  status                      String          @default("draft")
  publishedUrl                String?         @unique
  previewUrl                  String?
  domainName                  String?
  selectedDomain              String?
  paymentOptions              Json            @default("[]")
  offers                      Json            @default("[]")
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  backgroundColor             String          @default("#FFFFFF")
  fontColor                   String          @default("#000000")
  hasDomain                   Boolean         @default(false)
  headerBackgroundColor       String?
  headerFontColor             String?
  headerFontSize              String?
  homepageDishImageVisibility String?
  priceColor                  String?
  reservationButtonColor      String?
  reservationButtonShape      String?
  reservationButtonTextColor  String?
  addOns                      AddOnInstance[]
  business                    Business?       @relation(fields: [businessId], references: [id])
  templateData                Template?       @relation(fields: [selectedTemplate], references: [id])
  user                        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@index([status])
}

model MenuCategory {
  id         String     @id @default(uuid())
  name       String
  sortOrder  Int        @default(0)
  businessId String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  business   Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items      MenuItem[]

  @@index([businessId])
}

model MenuItem {
  id          String       @id @default(uuid())
  name        String
  description String?
  price       Decimal      @db.Decimal(10, 2)
  imageUrl    String?
  categoryId  String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  category    MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model WebApp {
  id          String       @id @default(uuid())
  userId      String
  configId    String       @unique
  subdomain   String       @unique
  configData  Json
  publishedAt DateTime?
  updatedAt   DateTime     @updatedAt
  createdAt   DateTime     @default(now())
  orders      OrderEvent[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subdomain])
}

model OrderEvent {
  id            String   @id @default(uuid())
  webAppId      String
  orderId       String?
  menuItemId    String?
  menuItemName  String
  orderedAt     DateTime @default(now())
  orderSource   String
  userAvatarUrl String?
  webApp        WebApp   @relation(fields: [webAppId], references: [id], onDelete: Cascade)

  @@index([webAppId])
  @@index([orderedAt])
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String    @unique
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  plan                 String    @default("free")
  status               String    @default("active")
  maxSites             Int       @default(1)
  maxUsers             Int       @default(1)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  canceledAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([stripeCustomerId])
}

model BillingEvent {
  id             String   @id @default(uuid())
  userId         String
  subscriptionId String?
  eventType      String
  amount         Int?
  currency       String   @default("EUR")
  stripeEventId  String?  @unique
  metadata       Json?
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType])
}

model ScraperJob {
  id                String    @id @default(dbgenerated("gen_random_uuid()"))
  businessName      String
  businessType      String?
  websiteUrl        String    @unique
  status            String    @default("pending")
  extractedData     Json?
  userId            String?
  createdAt         DateTime  @default(now())
  startedAt         DateTime?
  completedAt       DateTime?
  maitrScore        Int?      @default(0)
  email             String?
  phone             String?
  instagramUrl      String?
  menuUrl           String?
  hasReservation    Boolean   @default(false)
  googleSearchQuery String?
  analysisFeedback  String?
  isDeepScrapeReady Boolean   @default(false)
  user              User?     @relation(fields: [userId], references: [id])
}

model AddOnRegistry {
  id            String          @id
  name          String
  description   String
  category      String
  manifest      Json
  version       String          @default("1.0.0")
  creator       String          @default("maitr")
  isPublished   Boolean         @default(false)
  isPremium     Boolean         @default(false)
  installations Int             @default(0)
  avgRating     Float           @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  instances     AddOnInstance[]

  @@index([category])
  @@index([isPublished])
}

model AddOnInstance {
  id            String        @id @default(uuid())
  configId      String
  addOnId       String
  config        Json          @default("{}")
  status        String        @default("active")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  addOn         AddOnRegistry @relation(fields: [addOnId], references: [id], onDelete: Cascade)
  configuration Configuration @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, addOnId])
  @@index([configId])
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String
  action       String
  resource     String
  resourceId   String
  ipAddress    String?
  userAgent    String?
  success      Boolean  @default(true)
  errorMessage String?
  changes      Json?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resource, resourceId])
}

model Tenant {
  id           String       @id @default(uuid())
  slug         String       @unique
  userId       String
  schemaName   String       @unique
  restaurantId String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  restaurants  Restaurant[]
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Restaurant {
  id         String   @id @default(uuid())
  tenantId   String
  name       String
  configJson Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
}

enum BusinessStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  ARRIVED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum TableShape {
  ROUND
  SQUARE
  RECTANGLE
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum OrderType {
  DINE_IN
  TAKEOUT
  DELIVERY
}
